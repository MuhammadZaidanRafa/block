<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Block Puzzle Drag</title>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:url("bg.jpeg") center/cover no-repeat;
    min-height:100vh;
    display:flex;
    justify-content:center;
    color:white;
    user-select:none;
}

.game{
    width:100%;
    max-width:420px;
    padding:10px;
    background:rgba(0,0,0,.6);
    border-radius:10px;
}

h2{text-align:center;margin:5px 0}

.score{text-align:center;margin-bottom:10px;font-size:18px}

.board{
    display:grid;
    grid-template-columns:repeat(8,1fr);
    gap:4px;
    background:#2a2a2a;
    padding:4px;
    border-radius:8px;
}

.cell{
    aspect-ratio:1/1;
    background:#444;
    border-radius:4px;
}

.cell.filled{background:#00e5ff}
.cell.preview{outline:2px solid rgba(255,255,0,0.7)}

.blocks{
    display:flex;
    justify-content:space-around;
    margin-top:15px;
}

.block{
    display:grid;
    gap:3px;
    padding:5px;
    background:#222;
    border-radius:6px;
    touch-action:none; /* penting untuk drag di HP */
}

.block div{
    width:26px;
    height:26px;
    background:gold;
    border-radius:4px;
}

.credit{
    text-align:center;
    margin-top:10px;
    font-size:12px;
    color:#00ff6a;
}

/* GAME OVER */
.gameover{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:999;
}

.gameover-box{
    background:#111;
    padding:20px;
    border-radius:12px;
    text-align:center;
    width:280px;
    box-shadow:0 0 20px rgba(255,255,255,0.2);
}

.gameover-box button{
    margin-top:10px;
    padding:10px 18px;
    border:none;
    border-radius:8px;
    background:gold;
    font-weight:bold;
    cursor:pointer;
}

/* ghost drag */
.ghost{
    position:fixed;
    z-index:9999;
    pointer-events:none;
    opacity:0.85;
    transform:translate(-50%,-50%);
    display:grid;
    gap:3px;
    padding:5px;
    background:rgba(0,0,0,0.35);
    border-radius:8px;
}
.ghost div{
    width:26px;
    height:26px;
    background:gold;
    border-radius:4px;
}
</style>
</head>

<body>

<audio id="bgMusic" src="beach.mp3" loop></audio>

<div class="game">
    <h2>Block Puzzle Drag</h2>
    <div class="score">Skor: <span id="score">0</span></div>

    <div class="board" id="board"></div>
    <div class="blocks" id="blocks"></div>

    <div class="credit">made by Rafa and venom game</div>
</div>

<!-- GAME OVER -->
<div id="gameOver" class="gameover">
    <div class="gameover-box">
        <h2>GAME OVER</h2>
        <p>Skor Kamu: <span id="finalScore">0</span></p>
        <button onclick="restartGame()">Restart</button>
    </div>
</div>

<script>
/* AUDIO */
function aktifkanAudio(){
    const m=document.getElementById("bgMusic");
    m.play();
    document.removeEventListener("click",aktifkanAudio);
    document.removeEventListener("touchstart",aktifkanAudio);
}
document.addEventListener("click",aktifkanAudio);
document.addEventListener("touchstart",aktifkanAudio);

/* GAME */
const boardSize=8;
const board=document.getElementById("board");
const blocksEl=document.getElementById("blocks");
const scoreEl=document.getElementById("score");

const gameOverEl=document.getElementById("gameOver");
const finalScoreEl=document.getElementById("finalScore");

let score=0;
let cells=[];

let draggingBlock=null;
let draggingShape=null;
let ghost=null;

/* papan */
for(let i=0;i<64;i++){
    const c=document.createElement("div");
    c.className="cell";
    c.dataset.index=i;
    board.appendChild(c);
    cells.push(c);
}

/* bentuk */
const shapes=[
 [[1,1,1]],
 [[1,1],[1,1]],
 [[1],[1],[1]],
 [[1,1,1],[0,1,0]],
 [[1,1]]
];

function createBlocks(){
    blocksEl.innerHTML="";
    for(let i=0;i<3;i++){
        const shape=shapes[Math.floor(Math.random()*shapes.length)];
        const b=document.createElement("div");
        b.className="block";
        b.style.gridTemplateColumns=`repeat(${shape[0].length},26px)`;
        b.shapeData=shape;

        shape.flat().forEach(v=>{
            const d=document.createElement("div");
            if(!v) d.style.visibility="hidden";
            b.appendChild(d);
        });

        // DRAG START
        b.addEventListener("pointerdown",(e)=>{
            draggingBlock=b;
            draggingShape=b.shapeData;

            // buat ghost
            ghost=createGhost(draggingShape);
            document.body.appendChild(ghost);
            moveGhost(e.clientX,e.clientY);

            b.setPointerCapture(e.pointerId);
        });

        // DRAG MOVE
        b.addEventListener("pointermove",(e)=>{
            if(!draggingBlock) return;
            moveGhost(e.clientX,e.clientY);
            previewOnBoard(e.clientX,e.clientY);
        });

        // DRAG END
        b.addEventListener("pointerup",(e)=>{
            if(!draggingBlock) return;

            const dropIndex=getCellIndexFromPoint(e.clientX,e.clientY);

            clearPreview();

            if(dropIndex!==null && canPlace(draggingShape,dropIndex)){
                place(draggingShape,dropIndex);
                draggingBlock.remove();

                checkLine();

                if(blocksEl.children.length===0) createBlocks();

                if(isGameOver()) showGameOver();
            }

            // hapus ghost
            if(ghost) ghost.remove();
            ghost=null;

            draggingBlock=null;
            draggingShape=null;
        });

        blocksEl.appendChild(b);
    }
}

/* ghost */
function createGhost(shape){
    const g=document.createElement("div");
    g.className="ghost";
    g.style.gridTemplateColumns=`repeat(${shape[0].length},26px)`;

    shape.flat().forEach(v=>{
        const d=document.createElement("div");
        if(!v) d.style.visibility="hidden";
        g.appendChild(d);
    });

    return g;
}
function moveGhost(x,y){
    if(!ghost) return;
    ghost.style.left=x+"px";
    ghost.style.top=y+"px";
}

/* board helper */
function getCellIndexFromPoint(x,y){
    const el=document.elementFromPoint(x,y);
    if(!el) return null;

    if(el.classList.contains("cell")){
        return parseInt(el.dataset.index);
    }
    return null;
}

/* preview */
function clearPreview(){
    cells.forEach(c=>c.classList.remove("preview"));
}

function previewOnBoard(x,y){
    clearPreview();
    const index=getCellIndexFromPoint(x,y);
    if(index===null) return;

    if(!canPlace(draggingShape,index)) return;

    const startX=index%boardSize;
    const startY=Math.floor(index/boardSize);

    for(let r=0;r<draggingShape.length;r++){
        for(let c=0;c<draggingShape[r].length;c++){
            if(draggingShape[r][c]){
                const nx=startX+c;
                const ny=startY+r;
                cells[ny*boardSize+nx].classList.add("preview");
            }
        }
    }
}

function canPlace(shape,index){
    const x=index%boardSize;
    const y=Math.floor(index/boardSize);

    for(let r=0;r<shape.length;r++){
        for(let c=0;c<shape[r].length;c++){
            if(shape[r][c]){
                const nx=x+c, ny=y+r;
                if(nx>=boardSize||ny>=boardSize) return false;
                if(cells[ny*boardSize+nx].classList.contains("filled")) return false;
            }
        }
    }
    return true;
}

function place(shape,index){
    const x=index%boardSize;
    const y=Math.floor(index/boardSize);

    shape.forEach((row,r)=>{
        row.forEach((v,c)=>{
            if(v){
                cells[(y+r)*boardSize+(x+c)].classList.add("filled");
            }
        });
    });
}

/* CEK BARIS & KOLOM */
function checkLine(){
    let cleared=0;

    // baris
    for(let r=0;r<boardSize;r++){
        if([...Array(boardSize)].every((_,c)=>cells[r*8+c].classList.contains("filled"))){
            for(let c=0;c<8;c++) cells[r*8+c].classList.remove("filled");
            cleared++;
        }
    }

    // kolom
    for(let c=0;c<boardSize;c++){
        if([...Array(boardSize)].every((_,r)=>cells[r*8+c].classList.contains("filled"))){
            for(let r=0;r<8;r++) cells[r*8+c].classList.remove("filled");
            cleared++;
        }
    }

    if(cleared>0){
        score+=cleared*10;
        scoreEl.textContent=score;
    }
}

/* GAME OVER */
function isGameOver(){
    const blocks=[...blocksEl.children];

    for(let b of blocks){
        const shape=b.shapeData;

        for(let i=0;i<64;i++){
            if(canPlace(shape,i)) return false;
        }
    }
    return true;
}

function showGameOver(){
    finalScoreEl.textContent=score;
    gameOverEl.style.display="flex";
}

function restartGame(){
    cells.forEach(c=>c.classList.remove("filled"));
    score=0;
    scoreEl.textContent=0;

    createBlocks();
    gameOverEl.style.display="none";
}

createBlocks();
</script>

</body>
</html>
